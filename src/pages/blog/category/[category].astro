---
// src/pages/blog/category/[category].astro
import BaseLayout from "@/layouts/BaseLayout.astro";
import Card from "@/components/starwind/card/Card.astro";
import CardContent from "@/components/starwind/card/CardContent.astro";
import Button from "@/components/starwind/button/Button.astro";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  const categories = new Set<string>();

  posts.forEach((post) => {
    if (post.data.category) {
      categories.add(post.data.category.toLowerCase());
    }
  });

  return Array.from(categories).map((category) => ({
    params: { category },
  }));
}

const { category } = Astro.params;
const capitalizedCategory = category
  .split("-")
  .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
  .join(" ");

const allPosts = await getCollection("blog");
const posts = allPosts
  .filter((post) => post.data.category?.toLowerCase() === category)
  .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

const calculateReadingTime = (body: string) => {
  const wordsPerMinute = 200;
  const wordCount = body.split(/\s+/).length;
  return Math.ceil(wordCount / wordsPerMinute);
};
---

<BaseLayout
  title={`Blog Posts in ${capitalizedCategory} – Tecno Drishti`}
  description={`Explore all articles about ${capitalizedCategory} on Tecno Drishti blog.`}
>
  <main class="min-h-screen">
    <div class="mx-auto max-w-5xl px-6 py-16">
      <!-- Header -->
      <div class="text-center mb-16">
        <div class="inline-flex items-center gap-2 px-4 py-2 mb-6 bg-primary/10 text-primary rounded-full border border-primary/20 text-sm font-medium">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
          </svg>
          Category
        </div>
        <h1 class="text-5xl md:text-6xl font-bold tracking-tight mb-4">
          {capitalizedCategory}
        </h1>
        <p class="text-xl text-muted-foreground">
          {posts.length} {posts.length === 1 ? "article" : "articles"} found
        </p>
      </div>

      <!-- Posts Grid -->
      {posts.length > 0 ? (
        <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
          {posts.map((post) => (
            <Card class="hover:shadow-xl hover:-translate-y-2 transition-all duration-300 group overflow-hidden border-2 border-transparent hover:border-primary/20 h-full">
              <CardContent class="p-0 h-full flex flex-col">
                {post.data.heroImageLight && (
                  <div class="relative h-48 overflow-hidden">
                    <Image
                      src={post.data.heroImageLight}
                      alt={post.data.title}
                      width={400}
                      height={250}
                      class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300 block dark:hidden"
                    />
                    {post.data.heroImageDark && (
                      <Image
                        src={post.data.heroImageDark}
                        alt={post.data.title}
                        width={400}
                        height={250}
                        class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300 hidden dark:block"
                      />
                    )}
                    <div class="absolute inset-0 bg-linear-to-t from-black/60 to-transparent" />
                  </div>
                )}

                <div class="p-6 flex-1 flex flex-col">
                  <div class="mb-4">
                    <a
                      href={`/blog/category/${post.data.category?.toLowerCase()}/`}
                      class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-full bg-primary/10 text-primary border border-primary/20"
                    >
                      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                      </svg>
                      {post.data.category}
                    </a>
                  </div>

                  <h2 class="text-xl font-bold leading-tight group-hover:text-primary transition-colors line-clamp-2 mb-3">
                    <a href={`/blog/${post.slug}/`}>{post.data.title}</a>
                  </h2>

                  <p class="text-muted-foreground text-sm leading-relaxed line-clamp-3 mb-6">
                    {post.data.description}
                  </p>

                  {post.data.tags && post.data.tags.length > 0 && (
                    <div class="flex flex-wrap gap-2 mb-6">
                      {post.data.tags.map((tag) => (
                        <a
                          href={`/blog/tag/${tag.toLowerCase()}/`}
                          class="inline-flex items-center gap-1 px-3 py-1 text-xs font-medium rounded-md bg-muted/50 text-muted-foreground hover:bg-muted transition border border-border/50"
                        >
                          <span class="text-primary">#</span>{tag}
                        </a>
                      ))}
                    </div>
                  )}

                  <div class="mt-auto pt-4 border-t border-border">
                    <div class="flex items-center justify-between text-xs text-muted-foreground mb-4">
                      <time class="flex items-center gap-1">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        {post.data.pubDate.toLocaleDateString("en-US", { month: "short", day: "numeric" })}
                      </time>
                      <span class="flex items-center gap-1">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        {calculateReadingTime(post.body)} min
                      </span>
                    </div>

                    <Button
                      href={`/blog/${post.slug}/`}
                      variant="ghost"
                      size="sm"
                      class="w-full group-hover:bg-primary group-hover:text-primary-foreground transition-all"
                    >
                      Read Article →
                    </Button>
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      ) : (
        <div class="text-center py-24">
          <p class="text-xl text-muted-foreground">No posts found in this category yet.</p>
          <Button href="/blog" variant="outline" class="mt-6">Back to Blog</Button>
        </div>
      )}
    </div>
  </main>
</BaseLayout>