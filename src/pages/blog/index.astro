---
import Button from "@/components/starwind/button/Button.astro";
import Card from "@/components/starwind/card/Card.astro";
import CardContent from "@/components/starwind/card/CardContent.astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import BlogHero from "@/components/BlogHero.astro";
import FeaturedBlog from "@/components/FeaturedBlog.astro";

const posts = (await getCollection("blog")).sort(
  (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime()
);

const postsByYear = posts.reduce(
  (acc, post) => {
    const year = post.data.pubDate.getFullYear().toString();
    if (!acc[year]) acc[year] = [];
    acc[year].push(post);
    return acc;
  },
  {} as Record<string, typeof posts>
);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));

const calculateReadingTime = (body: string) => {
  const wordsPerMinute = 200;
  const wordCount = body.split(/\s+/).length;
  return Math.ceil(wordCount / wordsPerMinute);
};
---

<BaseLayout
  title="Techno Drishti Blog – Insights, Guides & Tutorials on Modern Technology"
  description="Explore the Techno Drishti blog for in-depth articles, tutorials, and practical insights on web development, software engineering, databases, DevOps, and modern developer tools."
>
  <main class="min-h-screen">
    <!-- Hero Section -->

    <BlogHero />
    <div class="mx-auto max-w-5xl px-6 py-16">
      <!-- Featured Post -->

      <FeaturedBlog />

      <!-- Search & Filter Bar -->
      <div
        class="mb-12 flex flex-col sm:flex-row gap-4 items-stretch sm:items-center"
      >
        <div class="relative flex-1">
          <input
            id="blog-search"
            type="text"
            placeholder="Search articles, tags, categories…"
            class="w-full rounded-lg border border-border bg-background px-4 py-3 pr-10 text-sm focus:outline-none focus:ring-2 focus:ring-primary/40 transition-all"
            autocomplete="off"
          />
          <svg
            class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground pointer-events-none"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-4.35-4.35m1.85-5.65a7.5 7.5 0 11-15 0 7.5 7.5 0 0115 0z"
            ></path>
          </svg>
        </div>

        <span
          id="search-count"
          class="text-sm text-muted-foreground whitespace-nowrap"
        >
          Showing{" "}
          <span id="search-count-number">{posts.length}</span>
          {posts.length === 1 ? " post" : " posts"}
        </span>
      </div>

      <!-- Timeline View -->
      <section id="posts-timeline">
        <div class="flex items-center gap-2 mb-10">
          <div class="h-px flex-1 bg-border"></div>
          <span
            class="text-sm font-semibold uppercase tracking-wide text-muted-foreground"
            >All Posts</span
          >
          <div class="h-px flex-1 bg-border"></div>
        </div>

        <div class="space-y-16">
          {
            years.map((year) => (
              <div class="year-section space-y-8" data-year={year}>
                <div class="year-header flex items-center gap-4 sticky top-4 bg-background/95 backdrop-blur-sm py-3 px-4 -mx-4 rounded-lg border border-border/50 z-10 shadow-sm">
                  <h3 class="text-3xl font-bold">{year}</h3>
                  <div class="h-px flex-1 bg-border" />
                  <span class="text-sm font-medium text-muted-foreground px-3 py-1 bg-muted rounded-full">
                    <span class="year-post-count">
                      {postsByYear[year].length}
                    </span>{" "}
                    {postsByYear[year].length === 1 ? "post" : "posts"}
                  </span>
                </div>

                <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                  {postsByYear[year].map((post) => (
                    <div
                      class="post-card"
                      data-search-text={`${post.data.title.toLowerCase()} ${post.data.description.toLowerCase()} ${post.data.category?.toLowerCase() || ""} ${post.data.tags?.map((t) => t.toLowerCase()).join(" ") || ""}`}
                    >
                      <Card class="hover:shadow-xl hover:-translate-y-2 transition-all duration-300 group overflow-hidden border-2 border-transparent hover:border-primary/20 h-full">
                        <CardContent class="p-0 h-full flex flex-col">
                          {post.data.heroImageLight && (
                            <div class="relative h-48 overflow-hidden">
                              <img
                                src={post.data.heroImageLight.src}
                                alt={post.data.title}
                                width={400}
                                height={250}
                                class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300 block dark:hidden"
                              />
                              {post.data.heroImageDark && (
                                <img
                                  src={post.data.heroImageDark.src}
                                  alt={post.data.title}
                                  width={400}
                                  height={250}
                                  class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300 hidden dark:block"
                                />
                              )}
                              <div class="absolute inset-0 bg-linear-to-t from-black/60 to-transparent" />

                              {post.data.category && (
                                <div class="absolute top-3 left-3">
                                  <a
                                    href={`/blog/category/${post.data.category.toLowerCase()}/`}
                                    class="inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-md bg-background/90 backdrop-blur-sm text-foreground border border-border/50"
                                  >
                                    {post.data.category}
                                  </a>
                                </div>
                              )}
                            </div>
                          )}

                          <div class="p-6 flex-1 flex flex-col space-y-4">
                            <div class="flex-1 space-y-3">
                              <h2 class="text-xl font-bold leading-tight group-hover:text-primary transition-colors line-clamp-2">
                                {post.data.title}
                              </h2>
                              <p class="text-muted-foreground text-sm leading-relaxed line-clamp-3">
                                {post.data.description}
                              </p>
                            </div>

                            {post.data.tags && post.data.tags.length > 0 && (
                              <div class="flex flex-wrap gap-1.5">
                                {post.data.tags.slice(0, 3).map((tag) => (
                                  <a
                                    href={`/blog/tag/${tag.toLowerCase()}/`}
                                    class="inline-flex items-center px-2 py-0.5 text-xs rounded-md bg-muted/50 text-muted-foreground border border-border/50"
                                  >
                                    #{tag}
                                  </a>
                                ))}
                                {post.data.tags.length > 3 && (
                                  <span class="inline-flex items-center px-2 py-0.5 text-xs rounded-md bg-muted/50 text-muted-foreground border border-border/50">
                                    +{post.data.tags.length - 3}
                                  </span>
                                )}
                              </div>
                            )}

                            <div class="pt-4 border-t border-border space-y-4">
                              <div class="flex items-center justify-between text-xs text-muted-foreground">
                                <time class="flex items-center gap-1">
                                  <svg
                                    class="w-3.5 h-3.5"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                  >
                                    <path
                                      stroke-linecap="round"
                                      stroke-linejoin="round"
                                      stroke-width="2"
                                      d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                                    />
                                  </svg>
                                  {post.data.pubDate.toLocaleDateString(
                                    "en-US",
                                    { month: "short", day: "numeric" }
                                  )}
                                </time>
                                <span class="flex items-center gap-1">
                                  <svg
                                    class="w-3.5 h-3.5"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                  >
                                    <path
                                      stroke-linecap="round"
                                      stroke-linejoin="round"
                                      stroke-width="2"
                                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                    />
                                  </svg>
                                  {calculateReadingTime(post.body)} min
                                </span>
                              </div>

                              <Button
                                href={`/blog/${post.slug}/`}
                                variant="ghost"
                                size="sm"
                                class="w-full group-hover:bg-primary group-hover:text-primary-foreground transition-all flex items-center justify-between"
                              >
                                Read Article
                                <svg
                                  class="w-4 h-4 group-hover:translate-x-1 transition-transform"
                                  fill="none"
                                  stroke="currentColor"
                                  viewBox="0 0 24 24"
                                >
                                  <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M9 5l7 7-7 7"
                                  />
                                </svg>
                              </Button>
                            </div>
                          </div>
                        </CardContent>
                      </Card>
                    </div>
                  ))}
                </div>
              </div>
            ))
          }
        </div>
      </section>

      <!-- No Results -->
      <div id="no-results" class="hidden text-center py-16">
        <div
          class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-muted/50 mb-6"
        >
          <svg
            class="w-10 h-10 text-muted-foreground"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
        <h3 class="text-2xl font-bold mb-2">No posts found</h3>
        <p class="text-muted-foreground">Try adjusting your search terms.</p>
      </div>

      <!-- Original empty state -->
      {
        posts.length === 0 && (
          <div class="text-center py-24">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-muted/50 text-muted-foreground mb-6">
              <svg
                class="w-10 h-10"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"
                />
              </svg>
            </div>
            <h3 class="text-2xl font-bold mb-3">No posts yet</h3>
            <p class="text-muted-foreground text-lg mb-8">
              Check back soon for new content and insights!
            </p>
            <Button href="/" variant="outline">
              Return Home
            </Button>
          </div>
        )
      }
    </div>
  </main>

  <!-- Fixed Client Script with Proper TypeScript -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const searchInput = document.getElementById(
        "blog-search"
      ) as HTMLInputElement | null;
      const searchCountNumber = document.getElementById(
        "search-count-number"
      ) as HTMLElement | null;
      const searchCount = document.getElementById(
        "search-count"
      ) as HTMLElement | null;
      const timeline = document.getElementById(
        "posts-timeline"
      ) as HTMLElement | null;
      const noResults = document.getElementById(
        "no-results"
      ) as HTMLElement | null;
      const yearSections = document.querySelectorAll(
        ".year-section"
      ) as NodeListOf<HTMLElement>;
      const postCards = document.querySelectorAll(
        ".post-card"
      ) as NodeListOf<HTMLElement>;

      if (
        !searchInput ||
        !searchCountNumber ||
        !searchCount ||
        !timeline ||
        !noResults
      )
        return;

      const performSearch = () => {
        const query = searchInput.value.trim().toLowerCase();
        let visibleTimelinePosts = 0;

        let hasAnyVisiblePosts = false;

        yearSections.forEach((section) => {
          let yearHasVisiblePosts = false;
          const header = section.querySelector(
            ".year-header"
          ) as HTMLElement | null;
          const cardsInYear = section.querySelectorAll(
            ".post-card"
          ) as NodeListOf<HTMLElement>;

          cardsInYear.forEach((card) => {
            const text = card.dataset.searchText || "";
            const matches = query === "" || text.includes(query);

            card.style.display = matches ? "" : "none";

            if (matches) {
              visibleTimelinePosts++;
              yearHasVisiblePosts = true;
              hasAnyVisiblePosts = true;
            }
          });

          // Show/hide entire year section
          if (header && section) {
            if (yearHasVisiblePosts || query === "") {
              section.style.display = "";
              header.style.display = "";
            } else {
              section.style.display = "none";
              header.style.display = "none";
            }
          }
        });

        // Update counter — only timeline posts
        searchCountNumber.textContent = visibleTimelinePosts.toString();
        if (searchCount.lastChild) {
          searchCount.lastChild.textContent =
            visibleTimelinePosts === 1 ? "post" : "posts";
        }

        // Show/hide no results message
        if (visibleTimelinePosts === 0 && query !== "") {
          noResults.classList.remove("hidden");
          timeline.style.display = "none";
        } else {
          noResults.classList.add("hidden");
          timeline.style.display = "";
        }
      };

      searchInput.addEventListener("input", performSearch);
      performSearch(); // Run once on load
    });
  </script>
</BaseLayout>
