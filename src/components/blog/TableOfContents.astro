---
interface Props {
  selector?: string;
  title?: string;
}

const {
  selector = "article",
  title = "In This Article",
} = Astro.props;
---

<aside
  class="mb-12 p-6 rounded-xl bg-muted/30 border border-border/50  top-24"
>
  <h2
    class="text-sm font-semibold uppercase tracking-wide text-muted-foreground mb-3 flex items-center gap-2"
  >
    <svg
      class="w-4 h-4"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M4 6h16M4 12h16M4 18h16"
      />
    </svg>
    {title}
  </h2>

  <nav>
    <ul
      id="toc"
      class="space-y-2 text-sm text-muted-foreground"
      aria-label="Table of contents"
    ></ul>
  </nav>
</aside>

<script lang="ts" define:vars={{ selector }}>
  function slugify(text) {
    return text
      .toLowerCase()
      .trim()
      .replace(/[^\w\s-]/g, "")
      .replace(/\s+/g, "-");
  }

  function buildTOC() {
    const container = document.querySelector(selector);

    const toc = document.getElementById("toc");

    if (!container || !toc) return;

    const headings = container.querySelectorAll("h1, h2, h3");

    toc.innerHTML = "";

    if (!headings.length) {
      toc.innerHTML =
        "<li class='text-xs text-muted-foreground'>No sections found</li>";
      return;
    }

    headings.forEach((heading, index) => {
      if (!heading.id) {
        heading.id = `${slugify(heading.textContent)}-${index}`;
      }

      const li = document.createElement("li");

      if (heading.tagName === "H2") li.className = "ml-2";
      if (heading.tagName === "H3") li.className = "ml-4 text-muted-foreground/80";

      const link = document.createElement("a");
      link.href = `#${heading.id}`;
      link.textContent = heading.textContent;
      link.className =
        "hover:text-primary transition-colors block leading-snug";

      link.addEventListener("click", (e) => {
        e.preventDefault();
        document
          .getElementById(heading.id)
          .scrollIntoView({ behavior: "smooth", block: "start" });
        history.pushState(null, "", `#${heading.id}`);
      });

      li.appendChild(link);
      toc.appendChild(li);
    });

    // Active section highlight on scroll
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const id = entry.target.id;
          const link = toc.querySelector(`a[href="#${id}"]`);

          if (!link) return;

          if (entry.isIntersecting) {
            toc.querySelectorAll("a").forEach((a) =>
              a.classList.remove("text-primary", "font-semibold"),
            );
            link.classList.add("text-primary", "font-semibold");
          }
        });
      },
      {
        rootMargin: "-40% 0px -55% 0px",
        threshold: 0.1,
      },
    );

    headings.forEach((heading) => observer.observe(heading));
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", buildTOC);
  } else {
    buildTOC();
  }
</script>
